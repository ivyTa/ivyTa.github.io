# 网络协议

![网络分层](images/network2.jpg)

程序是如何工作的  

当一个网络包从一个网口经过的时候，你看到了，首先先看看要不要请进来，处理一把。有的网口配置了混杂模式，凡是经过的，全部拿进来。  

拿进来以后，就要交给一段程序来处理。于是，你调用 process_layer2(buffer)。当然，这是一个假的函数。但是你明白其中的意思，知道肯定是有这么个函数的。那这个函数是干什么的呢？从 Buffer 中，摘掉二层的头，看一看，应该根据头里面的内容做什么操作。  

假设你发现这个包的 MAC 地址和你的相符，那说明就是发给你的，于是需要调用 process_layer3(buffer)。这个时候，Buffer 里面往往就没有二层的头了，因为已经在上一个函数的处理过程中拿掉了，或者将开始的偏移量移动了一下。在这个函数里面，摘掉三层的头，看看到底是发送给自己的，还是希望自己转发出去的。  

如何判断呢？如果 IP 地址不是自己的，那就应该转发出去；如果 IP 地址是自己的，那就是发给自己的。根据 IP 头里面的标示，拿掉三层的头，进行下一层的处理，到底是调用 process_tcp(buffer) 呢，还是调用 process_udp(buffer) 呢？  

假设这个地址是 TCP 的，则会调用 process_tcp(buffer)。这时候，Buffer 里面没有三层的头，就需要查看四层的头，看这是一个发起，还是一个应答，又或者是一个正常的数据包，然后分别由不同的逻辑进行处理。如果是发起或者应答，接下来可能要发送一个回复包；如果是一个正常的数据包，就需要交给上层了。交给谁呢？是不是有 process_http(buffer) 函数呢？  

没有的，如果你是一个网络包处理程序，你不需要有 process_http(buffer)，而是应该交给应用去处理。交给哪个应用呢？在四层的头里面有端口号，不同的应用监听不同的端口号。如果发现浏览器应用在监听这个端口，那你发给浏览器就行了。  

![理解网络分层](images/network1.jpg)

## 物理层

### 物理层的基本概念

物理层的主要任务描述为确定与传输媒体的接口的一些特性，即：  
**机械特性**   指明接口所用接线器的形状和尺寸、引线数目和排列、固定和锁定装置等等。  
**电气特性**   指明在接口电缆的各条线上出现的电压的范围。  
**功能特性**   指明某条线上出现的某一电平的电压表示何种意义。  
**过程特性**   指明对于不同功能的各种可能事件的出现顺序。  

![数据通信系统的模型](images/network3.png)

几个术语  

数据(data)——运送消息的实体。  
信号(signal)——数据的电气的或电磁的表现。  
“模拟的”(analogous)——代表消息的参数的取值是连续的。  
“数字的”(digital)——代表消息的参数的取值是离散的。  
码元(code)——在使用时间域（或简称为时域）的波形表示数字信号时，代表不同离散数值的基本波形。  

有关信号的几个基本概念  

单向通信（单工通信）——只能有一个方向的通信而没有反方向的交互。  
双向交替通信（半双工通信）——通信的双方都可以发送信息，但不能双方同时发送(当然也就不能同时接收)。  
双向同时通信（全双工通信）——通信的双方可以同时发送和接收信息。  

基带信号（即基本频带信号）——来自信源的信号。像计算机输出的代表各种文字或图像文件的数据信号都属于基带信号。  
基带信号往往包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量。因此必须对基带信号进行调制(modulation)。  
通带信号——把基带信号经过载波调制后，把信号的频率范围搬移到较高的频段以便在信道中传输（即仅在一段频率范围内能够通过信道）。  

基带信号(baseband)就是将数字信号 1 或 0 直接用两种不同的电压来表示，然后送到线路上去传输。  
宽带信号(broadband)则是将基带信号进行调制后形成的频分复用模拟信号。  
通带信号(passband)被搬移到某个更大频率范围的信号。  

几种最基本的调制方法  
  
基带信号往往包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量。为了解决这一问题，就必须对基带信号进行调制(modulation)。  
最基本的二元制调制方法有以下几种：  
调幅(AM)：载波的振幅随基带数字信号而变化。  
调频(FM)：载波的频率随基带数字信号而变化。  
调相(PM) ：载波的初始相位随基带数字信号而变化。  

![基带信号](images/network4.png)

所谓调制就是进行波形变换。或者更严格地讲，是进行频谱变换，将基带数字信号的频谱变换成为适合于在模拟信道中传输的频谱。最基本的调制方法有以下几种：  
(1)调幅(AM) 即载波的振幅随基带数字信号而变化。例如，0对应于无载波输出，而1对应于有载波输出。  
(2)调频(FM) 即载波的频率随基带数字信号而变化。例如，0对应于频率f1，而1对应于频率f2。  
(3)调相(PM) 即载波的初始相位随基带数字信号而变化。例如，0对应于相位0o，而1对应于180o。  

根据载波 Asin(t + )的三个特性：幅度、频率、相位，产生常用的三种调制技术：  
幅移键控法 Amplitude-shift keying (ASK)  
频移键控法 Frequency-shift keying (FSK)  
相移键控法 Phase-shift keying (PSK)  

调制解调器的速率  

目前调制解调器的信息传输速率已很接近于香农的信道容量极限了。  
要提高信息传输速率，只能设法提高信噪比。  
在电话的用户线上，最大的噪声来自模拟到数字的模数转换所带来的量化噪声。  

调制解调器使用异步通信方式  

数据通信可分为同步通信和异步通信两大类：  
同步通信要求接收端时钟频率和发送端时钟频率一致。发送端发送连续的比特流。  
异步通信时不要求接收端时钟和发送端时钟同步。发送端发送完一个字节后，可经过任意长的时间间隔再发送下一个字节。  
异步通信的通信开销较大，但接收端可使用廉价的、具有一般精度的时钟来进行数据通信。  

数字传输系统  

现在的数字传输系统均采用脉码调制 PCM (Pulse Code Modulation)体制。  
PCM最初并不是为传送计算机数据用的。它是为了使电话局之间一条中继线不是只传送一路电话而是可以传送几十路的电话。由于历史上的原因，PCM有两个互不兼容的国际标准，即北美的24路PCM(简称为T1)和欧洲的30路PCM(简称为E1)。  
T1的速率是1.544 Mb/s，E1的速率是2.048 Mb/s。  

脉码调制PCM  
  
为了将模拟电话信号转变为数字信号，必须先对电话信号进行取样。根据取样定理，只要：取样频率不低于电话信号最高频率的2倍，就可以从取样脉冲信号无失真地恢复出原来的电话信号。标准的电话信号的最高频率为3.4kHz，为方便起见，取样频率就定为8kHz，相当于取样周期为125 s。  

PCM的基本原理  

T为取样周期。连续的电话信号经取样后成为如图中(a)所示的离散脉冲信号，其振幅对应于取样时刻电话信号的数值。  
下一步就是编码。为简单起见,图(c)将不同振幅的脉冲编为4位二进制码元。在我国使用的PCM体制中，电话信号是采用8 bit编码,也就是说,将取样后的模拟的电话信号量化为256个不同等级中的一个。模拟信号转换为数字信号后就进行传输。  
在接收端进行解码的过程与编码过程相反。经滤波后最后得出恢复后的模拟电话信号图中的(e)。  

![基带信号](images/network5.png)

这样，一个话路的模拟电话信号，经模数变换后，就变成为每秒8000个脉冲信号，每个脉冲信号再编为8位二进制码元。因此一个标准话路的PCM信号速率为64 kb/s。  
以kb/s的速率是最早制订出的话音编码的标准速率。  
随着话音编码技术的不断发展，人们可以用更低的数据率来传送同样质量的话音信号。现在已经能够用32kb/s，16kb/s或甚至低到8kb/s(或更低)的数据率来传送一路话音信号。  

### 时分复用

为了有效地利用传输线路，可将多个话路的PCM 信号用时分复用 TDM (Time Division Multiplexing)的方法装成时分复用帧，然后发送到线路上。  
中国采用欧洲体制，以 E1 为一次群。  
美国和日本等国采用北美体制，以 T1 为一次群。  

E1的一个时分复用帧(其长度T＝125s)共划分为32相等的时隙，时隙的编号为CH0-CH31。时隙CH0用作帧同步用，时隙CH16用来传送信令(如用户的拨号信令)。可供用户使用的话路是时隙CH1-CH15和CH17-CH31，共30个时隙用作30个话路。每个时隙共传送8 bit。因此整个的32个时隙共用256bit。每秒传送8000个帧，因此PCM一次群E1的数据率就是2.048Mb/s。  
北美使用的T1系统共有24个话路。每个话路的取样脉冲用7bit编码，然后再加上1位信令码元，因此一个话路也是占用8bit。帧同步码是在24路的编码之后加上1bit，这样每帧共有193bit。因此T1一次群的数据率为1.544Mb/s。  

E1 的时分复用帧  

![E1 的时分复用帧 ](images/network6.png)

信道的极限容量  

任何实际的信道都不是理想的，在传输信号时会产生各种失真以及带来多种干扰。  
码元(时间轴上的一个信号编码单元)传输的速率越高，或信号传输的距离越远，在信道的输出端的波形的失真就越严重。  

数字信号通过实际的信道  

![数字信号通过实际的信道 ](images/network7.png)

1924年，尼奎斯特（H. Nyquist）推导出理想低通信道的最高码元传输速率 = 2H Baud  

每赫带宽的理想低通信道的最高码元传输速率是每秒 2  个码元。  
Baud 是波特，是码元传输速率的单位，1 波特为每秒传送 1 个码元。  

实际的信道所能传输的最高码元速率，要明显地低于尼氏准则给出上限数值。  
当信号电平分为Ｖ级，尼奎斯特（H. Nyquist）无噪声有限带宽信道的最大数据传输率公式表示为：最大数据传输率 = 2Hlog2V (bps)  
这说明，任意信号通过一个带宽为Ｈ的低通滤波器，则每秒采样2Ｈ次就能完整地重现该信号。  
例如，V=2（只有两级），无噪声的3k Hz信道传输二进制最高的速率是6000 bps。  

波特(Baud)和比特(bit)是两个完全不同的概念。  
波特是码元传输的速率单位（每秒传多少个码元）。码元传输速率也称为调制速率、波形速率或符号速率。  
比特是信息量的单位。  
信息的传输速率“比特/秒”与码元的传输速率“波特”在数量上却有一定的关系。  
若1个码元只携带 1 bit 的信息量，则“比特/秒”和“波特”在数值上相等。  
若1个码元携带n bit 的信息量，则 M Baud的码元传输速率所对应的信息传输速率为M*n b/s。  

波特率（baud）和比特率（bit）的关系  

波特率：信号每秒钟变化的次数，也称调制速率。  
比特率：每秒钟传送的二进制位数。  
波特率与比特率的关系取决于信号值与比特位的关系。  
例：每个信号值可表示３位，则比特率是波特率的３倍；每个信号值可表示１位，则比特率和波特率相同。  
例如，有一个带宽为3kHz的理想低通信道，其最高码元传输速率为6000 Baud(即每秒传6000个码元)。若1个码元能携带3bit的信息量，则最高信息传输速率为18000 b/s。  

### 信噪比

香农(Shannon)用信息论的理论推导出了带宽受限且有高斯白噪声干扰的信道的极限、无差错的信息传输速率。  
信道的极限信息传输速率 C 可表达为 C = W log2(1+S/N)  b/s  
W 为信道的带宽（以 Hz 为单位）；  
S 为信道内所传信号的平均功率；  
N 为信道内部的高斯噪声功率。  

热噪声出现的大小用信噪比（信号功率与噪声功率之比: 用S/N或SNR表示）来衡量。  
 S：信号功率，N：噪声功率  
 10log10S/N, 单位：分贝（dB）  
 即，人们常说的信噪比，是指10log10S/N值  
如信噪比10分贝，实际上S/N=10  
如信噪比20分贝，实际上S/N=100  
如信噪比30分贝，实际上S/N=1000  

香农公式表明  

信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高。  
只要信息传输速率低于信道的极限信息传输速率，就一定可以找到某种办法来实现无差错的传输。  
若信道带宽 W 或信噪比 S/N 没有上限（当然实际信道不可能是这样的），则信道的极限信息传输速率 C 也就没有上限。  
实际信道上能够达到的信息传输速率要比香农的极限传输速率低不少。  

### 物理层下面的传输媒体

![物理层下面的传输媒体 ](images/network8.png)

导引型传输媒体  

1. 双裸线  
2. 双绞线  

- 屏蔽双绞线 STP (Shielded Twisted Pair)  
- 无屏蔽双绞线 UTP (Unshielded Twisted Pair)  

3. 同轴电缆  

- 50  同轴电缆  
- 75  同轴电缆  

4. 光缆  

### 信道复用技术

复用(multiplexing)是通信技术中的基本概念。  

![复用](images/network9.png)

#### 频分复用 FDM(Frequency Division Multiplexing)

用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。  
频分复用的所有用户在同样的时间占用不同的带宽资源（请注意，这里的“带宽”是频率带宽而不是数据的发送速率）。  

![频分复用](images/network10.png)

#### 时分复用TDM(Time Division Multiplexing)

时分复用则是将时间划分为一段段等长的时分复用帧（TDM 帧）。每一个时分复用的用户在每一个 TDM 帧中占用固定序号的时隙。  
每一个用户所占用的时隙是周期性地出现（其周期就是 TDM  帧的长度）。  
TDM 信号也称为等时(isochronous)信号。  
时分复用的所有用户是在不同的时间占用同样的频带宽度。  

![时分复用](images/network11.png)

时分复用可能会造成线路资源的浪费  

使用时分复用系统传送计算机数据时，由于计算机数据的突发性质，用户对分配到的子信道的利用率一般是不高的。  

![时分复用](images/network12.png)

#### 统计时分复用 STDM(Statistic TDM)  

![统计时分复用](images/network13.png)

#### 波分复用 WDM(Wavelength Division Multiplexing)  

波分复用就是光的频分复用。  

![波分复用](images/network14.png)

#### 码分复用 CDM(Code Division Multiplexing)  

常用的名词是码分多址 CDMA (Code Division Multiple Access)。  
各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰。  
这种系统发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现。  
每一个比特时间划分为 m 个短的间隔，称为码片(chip)。  

#### 码片序列(chip sequence)

每个站被指派一个唯一的 m bit 码片序列。  
如发送比特 1，则发送自己的 m bit 码片序列。  
如发送比特 0，则发送该码片序列的二进制反码。  
例如，S 站的 8 bit 码片序列是 00011011。  
发送比特 1 时，就发送序列 00011011，  
发送比特 0 时，就发送序列 11100100。  
S 站的码片序列：(–1 –1 –1 +1 +1 –1 +1 +1)  

### 物理层设备

中继器/转发器(RP，Repeater)  
工作在物理层上的连接设备。  
适用于完全相同的两类网络的互连，主要功能是通过对数据信号的重新发送或者转发，来扩大网络传输的距离。  
中继器是对信号进行再生和还原的网络设备，用于扩展局域网网段的长度（仅用于连接相同的局域网网段）  

集线器  
主要功能是对接收到的信号进行再生整形放大，以扩大网络的传输距离，同时把所有节点集中在以它为中心的节点上。  
它工作于OSI(开放系统互联参考模型)参考模型第一层，即“物理层”。  
集线器每个接口简单的收发比特，收到1就转发1，收到0就转发0，不进行碰撞检测。  

## 数据链路层

数据链路层使用的信道主要有以下两种类型：  
点对点信道。这种信道使用一对一的点对点通信方式。  
广播信道。这种信道使用一对多的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发。  

数据链路层的简单模型

![数据链路层的简单模型](images/network15.png)

链路(link)是一条无源的点到点的物理线路段，中间没有任何其他的交换结点。  
一条链路只是一条通路的一个组成部分。  
数据链路(data link) 除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。  
现在最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。  
一般的适配器都包括了数据链路层和物理层这两层的功能。  

数据链路层传送的是帧

![数据链路层传送的是帧](images/network16.png)

数据链路层像个数字管道  
常常在两个对等的数据链路层之间画出一个数字管道，而在这条数字管道上传输的数据单位是帧。  

![帧](images/network17.png)

早期的数据通信协议曾叫作通信规程(procedure)。因此在数据链路层，规程和协议是同义语。  

### 封装成帧

封装成帧(framing)就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。确定帧的界限。  
首部和尾部的一个重要作用就是进行帧定界。  

![封装成帧](images/network18.png)

#### 透明传输

![透明传输](images/network19.png)

解决透明传输问题  

发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入一个转义字符“ESC”(其十六进制编码是 1B)。  
字节填充(byte stuffing)或字符填充(character stuffing)——接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。  
如果转义字符也出现数据当中，那么应在转义字符前面插入一个转义字符。当接收端收到连续的两个转义字符时，就删除其中前面的一个。  

用字节填充法解决透明传输的问题  

![字节填充](images/network20.png)

#### 错误检测和纠正

差错出现的特点：随机，连续突发（burst）  
处理差错的两种基本策略  
使用纠错码：发送方在每个数据块中加入足够的冗余信息，使得接收方能够判断接收到的数据是否有错，并能纠正错误。  
使用检错码：发送方在每个数据块中加入足够的冗余信息，使得接收方能够判断接收到的数据是否有错，但不能判断哪里有错。  

##### 纠错码

码字（codeword）：一个帧包括m个数据位，r个校验位，n = m + r，则此n比特单元称为n位码字。  
海明距离（Hamming distance）：两个码字之间不同的比特(对应)位数目。  
例：0000000000 与0000011111的海明距离为5  
如果两个码字的海明距离为d，则需要d个单比特错就可以把一个码字转换成另一个码字；  
对于n位码字的集合，只有2m个码字是有效的。也就是说，通常并未使用所有2n个码字。  


















参考：https://time.geekbang.org/column/article/7724  
