# 网络协议

![网络分层](images/network2.jpg)

程序是如何工作的  

当一个网络包从一个网口经过的时候，你看到了，首先先看看要不要请进来，处理一把。有的网口配置了混杂模式，凡是经过的，全部拿进来。  

拿进来以后，就要交给一段程序来处理。于是，你调用 process_layer2(buffer)。当然，这是一个假的函数。但是你明白其中的意思，知道肯定是有这么个函数的。那这个函数是干什么的呢？从 Buffer 中，摘掉二层的头，看一看，应该根据头里面的内容做什么操作。  

假设你发现这个包的 MAC 地址和你的相符，那说明就是发给你的，于是需要调用 process_layer3(buffer)。这个时候，Buffer 里面往往就没有二层的头了，因为已经在上一个函数的处理过程中拿掉了，或者将开始的偏移量移动了一下。在这个函数里面，摘掉三层的头，看看到底是发送给自己的，还是希望自己转发出去的。  

如何判断呢？如果 IP 地址不是自己的，那就应该转发出去；如果 IP 地址是自己的，那就是发给自己的。根据 IP 头里面的标示，拿掉三层的头，进行下一层的处理，到底是调用 process_tcp(buffer) 呢，还是调用 process_udp(buffer) 呢？  

假设这个地址是 TCP 的，则会调用 process_tcp(buffer)。这时候，Buffer 里面没有三层的头，就需要查看四层的头，看这是一个发起，还是一个应答，又或者是一个正常的数据包，然后分别由不同的逻辑进行处理。如果是发起或者应答，接下来可能要发送一个回复包；如果是一个正常的数据包，就需要交给上层了。交给谁呢？是不是有 process_http(buffer) 函数呢？  

没有的，如果你是一个网络包处理程序，你不需要有 process_http(buffer)，而是应该交给应用去处理。交给哪个应用呢？在四层的头里面有端口号，不同的应用监听不同的端口号。如果发现浏览器应用在监听这个端口，那你发给浏览器就行了。  

![理解网络分层](images/network1.jpg)

## 物理层

### 物理层的基本概念

物理层的主要任务描述为确定与传输媒体的接口的一些特性，即：  
**机械特性**   指明接口所用接线器的形状和尺寸、引线数目和排列、固定和锁定装置等等。  
**电气特性**   指明在接口电缆的各条线上出现的电压的范围。  
**功能特性**   指明某条线上出现的某一电平的电压表示何种意义。  
**过程特性**   指明对于不同功能的各种可能事件的出现顺序。  

![数据通信系统的模型](images/network3.png)

几个术语  

数据(data)——运送消息的实体。  
信号(signal)——数据的电气的或电磁的表现。  
“模拟的”(analogous)——代表消息的参数的取值是连续的。  
“数字的”(digital)——代表消息的参数的取值是离散的。  
码元(code)——在使用时间域（或简称为时域）的波形表示数字信号时，代表不同离散数值的基本波形。  

有关信号的几个基本概念  

单向通信（单工通信）——只能有一个方向的通信而没有反方向的交互。  
双向交替通信（半双工通信）——通信的双方都可以发送信息，但不能双方同时发送(当然也就不能同时接收)。  
双向同时通信（全双工通信）——通信的双方可以同时发送和接收信息。  

基带信号（即基本频带信号）——来自信源的信号。像计算机输出的代表各种文字或图像文件的数据信号都属于基带信号。  
基带信号往往包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量。因此必须对基带信号进行调制(modulation)。  
通带信号——把基带信号经过载波调制后，把信号的频率范围搬移到较高的频段以便在信道中传输（即仅在一段频率范围内能够通过信道）。  

基带信号(baseband)就是将数字信号 1 或 0 直接用两种不同的电压来表示，然后送到线路上去传输。  
宽带信号(broadband)则是将基带信号进行调制后形成的频分复用模拟信号。  
通带信号(passband)被搬移到某个更大频率范围的信号。  

几种最基本的调制方法  
  
基带信号往往包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量。为了解决这一问题，就必须对基带信号进行调制(modulation)。  
最基本的二元制调制方法有以下几种：  
调幅(AM)：载波的振幅随基带数字信号而变化。  
调频(FM)：载波的频率随基带数字信号而变化。  
调相(PM) ：载波的初始相位随基带数字信号而变化。  

![基带信号](images/network4.png)

所谓调制就是进行波形变换。或者更严格地讲，是进行频谱变换，将基带数字信号的频谱变换成为适合于在模拟信道中传输的频谱。最基本的调制方法有以下几种：  
(1)调幅(AM) 即载波的振幅随基带数字信号而变化。例如，0对应于无载波输出，而1对应于有载波输出。  
(2)调频(FM) 即载波的频率随基带数字信号而变化。例如，0对应于频率f1，而1对应于频率f2。  
(3)调相(PM) 即载波的初始相位随基带数字信号而变化。例如，0对应于相位0o，而1对应于180o。  

根据载波 Asin(t + )的三个特性：幅度、频率、相位，产生常用的三种调制技术：  
幅移键控法 Amplitude-shift keying (ASK)  
频移键控法 Frequency-shift keying (FSK)  
相移键控法 Phase-shift keying (PSK)  

调制解调器的速率  

目前调制解调器的信息传输速率已很接近于香农的信道容量极限了。  
要提高信息传输速率，只能设法提高信噪比。  
在电话的用户线上，最大的噪声来自模拟到数字的模数转换所带来的量化噪声。  

调制解调器使用异步通信方式  

数据通信可分为同步通信和异步通信两大类：  
同步通信要求接收端时钟频率和发送端时钟频率一致。发送端发送连续的比特流。  
异步通信时不要求接收端时钟和发送端时钟同步。发送端发送完一个字节后，可经过任意长的时间间隔再发送下一个字节。  
异步通信的通信开销较大，但接收端可使用廉价的、具有一般精度的时钟来进行数据通信。  

数字传输系统  

现在的数字传输系统均采用脉码调制 PCM (Pulse Code Modulation)体制。  
PCM最初并不是为传送计算机数据用的。它是为了使电话局之间一条中继线不是只传送一路电话而是可以传送几十路的电话。由于历史上的原因，PCM有两个互不兼容的国际标准，即北美的24路PCM(简称为T1)和欧洲的30路PCM(简称为E1)。  
T1的速率是1.544 Mb/s，E1的速率是2.048 Mb/s。  

脉码调制PCM  
  
为了将模拟电话信号转变为数字信号，必须先对电话信号进行取样。根据取样定理，只要：取样频率不低于电话信号最高频率的2倍，就可以从取样脉冲信号无失真地恢复出原来的电话信号。标准的电话信号的最高频率为3.4kHz，为方便起见，取样频率就定为8kHz，相当于取样周期为125 s。  

PCM的基本原理  

T为取样周期。连续的电话信号经取样后成为如图中(a)所示的离散脉冲信号，其振幅对应于取样时刻电话信号的数值。  
下一步就是编码。为简单起见,图(c)将不同振幅的脉冲编为4位二进制码元。在我国使用的PCM体制中，电话信号是采用8 bit编码,也就是说,将取样后的模拟的电话信号量化为256个不同等级中的一个。模拟信号转换为数字信号后就进行传输。  
在接收端进行解码的过程与编码过程相反。经滤波后最后得出恢复后的模拟电话信号图中的(e)。  

![基带信号](images/network5.png)

这样，一个话路的模拟电话信号，经模数变换后，就变成为每秒8000个脉冲信号，每个脉冲信号再编为8位二进制码元。因此一个标准话路的PCM信号速率为64 kb/s。  
以kb/s的速率是最早制订出的话音编码的标准速率。  
随着话音编码技术的不断发展，人们可以用更低的数据率来传送同样质量的话音信号。现在已经能够用32kb/s，16kb/s或甚至低到8kb/s(或更低)的数据率来传送一路话音信号。  

### 时分复用

为了有效地利用传输线路，可将多个话路的PCM 信号用时分复用 TDM (Time Division Multiplexing)的方法装成时分复用帧，然后发送到线路上。  
中国采用欧洲体制，以 E1 为一次群。  
美国和日本等国采用北美体制，以 T1 为一次群。  

E1的一个时分复用帧(其长度T＝125s)共划分为32相等的时隙，时隙的编号为CH0-CH31。时隙CH0用作帧同步用，时隙CH16用来传送信令(如用户的拨号信令)。可供用户使用的话路是时隙CH1-CH15和CH17-CH31，共30个时隙用作30个话路。每个时隙共传送8 bit。因此整个的32个时隙共用256bit。每秒传送8000个帧，因此PCM一次群E1的数据率就是2.048Mb/s。  
北美使用的T1系统共有24个话路。每个话路的取样脉冲用7bit编码，然后再加上1位信令码元，因此一个话路也是占用8bit。帧同步码是在24路的编码之后加上1bit，这样每帧共有193bit。因此T1一次群的数据率为1.544Mb/s。  

E1 的时分复用帧  

![E1 的时分复用帧 ](images/network6.png)

信道的极限容量  

任何实际的信道都不是理想的，在传输信号时会产生各种失真以及带来多种干扰。  
码元(时间轴上的一个信号编码单元)传输的速率越高，或信号传输的距离越远，在信道的输出端的波形的失真就越严重。  

数字信号通过实际的信道  

![数字信号通过实际的信道 ](images/network7.png)

1924年，尼奎斯特（H. Nyquist）推导出理想低通信道的最高码元传输速率 = 2H Baud  

每赫带宽的理想低通信道的最高码元传输速率是每秒 2  个码元。  
Baud 是波特，是码元传输速率的单位，1 波特为每秒传送 1 个码元。  

实际的信道所能传输的最高码元速率，要明显地低于尼氏准则给出上限数值。  
当信号电平分为Ｖ级，尼奎斯特（H. Nyquist）无噪声有限带宽信道的最大数据传输率公式表示为：最大数据传输率 = 2Hlog2V (bps)  
这说明，任意信号通过一个带宽为Ｈ的低通滤波器，则每秒采样2Ｈ次就能完整地重现该信号。  
例如，V=2（只有两级），无噪声的3k Hz信道传输二进制最高的速率是6000 bps。  

波特(Baud)和比特(bit)是两个完全不同的概念。  
波特是码元传输的速率单位（每秒传多少个码元）。码元传输速率也称为调制速率、波形速率或符号速率。  
比特是信息量的单位。  
信息的传输速率“比特/秒”与码元的传输速率“波特”在数量上却有一定的关系。  
若1个码元只携带 1 bit 的信息量，则“比特/秒”和“波特”在数值上相等。  
若1个码元携带n bit 的信息量，则 M Baud的码元传输速率所对应的信息传输速率为M*n b/s。  

波特率（baud）和比特率（bit）的关系  

波特率：信号每秒钟变化的次数，也称调制速率。  
比特率：每秒钟传送的二进制位数。  
波特率与比特率的关系取决于信号值与比特位的关系。  
例：每个信号值可表示３位，则比特率是波特率的３倍；每个信号值可表示１位，则比特率和波特率相同。  
例如，有一个带宽为3kHz的理想低通信道，其最高码元传输速率为6000 Baud(即每秒传6000个码元)。若1个码元能携带3bit的信息量，则最高信息传输速率为18000 b/s。  

### 信噪比

香农(Shannon)用信息论的理论推导出了带宽受限且有高斯白噪声干扰的信道的极限、无差错的信息传输速率。  
信道的极限信息传输速率 C 可表达为 C = W log2(1+S/N)  b/s  
W 为信道的带宽（以 Hz 为单位）；  
S 为信道内所传信号的平均功率；  
N 为信道内部的高斯噪声功率。  

热噪声出现的大小用信噪比（信号功率与噪声功率之比: 用S/N或SNR表示）来衡量。  
 S：信号功率，N：噪声功率  
 10log10S/N, 单位：分贝（dB）  
 即，人们常说的信噪比，是指10log10S/N值  
如信噪比10分贝，实际上S/N=10  
如信噪比20分贝，实际上S/N=100  
如信噪比30分贝，实际上S/N=1000  

香农公式表明  

信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高。  
只要信息传输速率低于信道的极限信息传输速率，就一定可以找到某种办法来实现无差错的传输。  
若信道带宽 W 或信噪比 S/N 没有上限（当然实际信道不可能是这样的），则信道的极限信息传输速率 C 也就没有上限。  
实际信道上能够达到的信息传输速率要比香农的极限传输速率低不少。  

### 物理层下面的传输媒体

![物理层下面的传输媒体 ](images/network8.png)

导引型传输媒体  

1. 双裸线  
2. 双绞线  

- 屏蔽双绞线 STP (Shielded Twisted Pair)  
- 无屏蔽双绞线 UTP (Unshielded Twisted Pair)  

3. 同轴电缆  

- 50  同轴电缆  
- 75  同轴电缆  

4. 光缆  

### 信道复用技术

复用(multiplexing)是通信技术中的基本概念。  

![复用](images/network9.png)

#### 频分复用 FDM(Frequency Division Multiplexing)

用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。  
频分复用的所有用户在同样的时间占用不同的带宽资源（请注意，这里的“带宽”是频率带宽而不是数据的发送速率）。  

![频分复用](images/network10.png)

#### 时分复用TDM(Time Division Multiplexing)

时分复用则是将时间划分为一段段等长的时分复用帧（TDM 帧）。每一个时分复用的用户在每一个 TDM 帧中占用固定序号的时隙。  
每一个用户所占用的时隙是周期性地出现（其周期就是 TDM  帧的长度）。  
TDM 信号也称为等时(isochronous)信号。  
时分复用的所有用户是在不同的时间占用同样的频带宽度。  

![时分复用](images/network11.png)

时分复用可能会造成线路资源的浪费  

使用时分复用系统传送计算机数据时，由于计算机数据的突发性质，用户对分配到的子信道的利用率一般是不高的。  

![时分复用](images/network12.png)

#### 统计时分复用 STDM(Statistic TDM)  

![统计时分复用](images/network13.png)

#### 波分复用 WDM(Wavelength Division Multiplexing)  

波分复用就是光的频分复用。  

![波分复用](images/network14.png)

#### 码分复用 CDM(Code Division Multiplexing)  

常用的名词是码分多址 CDMA (Code Division Multiple Access)。  
各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰。  
这种系统发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现。  
每一个比特时间划分为 m 个短的间隔，称为码片(chip)。  

#### 码片序列(chip sequence)

每个站被指派一个唯一的 m bit 码片序列。  
如发送比特 1，则发送自己的 m bit 码片序列。  
如发送比特 0，则发送该码片序列的二进制反码。  
例如，S 站的 8 bit 码片序列是 00011011。  
发送比特 1 时，就发送序列 00011011，  
发送比特 0 时，就发送序列 11100100。  
S 站的码片序列：(–1 –1 –1 +1 +1 –1 +1 +1)  

### 物理层设备

中继器/转发器(RP，Repeater)  
工作在物理层上的连接设备。  
适用于完全相同的两类网络的互连，主要功能是通过对数据信号的重新发送或者转发，来扩大网络传输的距离。  
中继器是对信号进行再生和还原的网络设备，用于扩展局域网网段的长度（仅用于连接相同的局域网网段）  

集线器  
主要功能是对接收到的信号进行再生整形放大，以扩大网络的传输距离，同时把所有节点集中在以它为中心的节点上。  
它工作于OSI(开放系统互联参考模型)参考模型第一层，即“物理层”。  
集线器每个接口简单的收发比特，收到1就转发1，收到0就转发0，不进行碰撞检测。  

## 数据链路层

数据链路层使用的信道主要有以下两种类型：  
点对点信道。这种信道使用一对一的点对点通信方式。  
广播信道。这种信道使用一对多的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发。  

数据链路层的简单模型

![数据链路层的简单模型](images/network15.png)

链路(link)是一条无源的点到点的物理线路段，中间没有任何其他的交换结点。  
一条链路只是一条通路的一个组成部分。  
数据链路(data link) 除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。  
现在最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。  
一般的适配器都包括了数据链路层和物理层这两层的功能。  

数据链路层传送的是帧

![数据链路层传送的是帧](images/network16.png)

数据链路层像个数字管道  
常常在两个对等的数据链路层之间画出一个数字管道，而在这条数字管道上传输的数据单位是帧。  

![帧](images/network17.png)

早期的数据通信协议曾叫作通信规程(procedure)。因此在数据链路层，规程和协议是同义语。  

### 封装成帧

封装成帧(framing)就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。确定帧的界限。  
首部和尾部的一个重要作用就是进行帧定界。  

![封装成帧](images/network18.png)

#### 透明传输

![透明传输](images/network19.png)

解决透明传输问题  

发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入一个转义字符“ESC”(其十六进制编码是 1B)。  
字节填充(byte stuffing)或字符填充(character stuffing)——接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。  
如果转义字符也出现数据当中，那么应在转义字符前面插入一个转义字符。当接收端收到连续的两个转义字符时，就删除其中前面的一个。  

用字节填充法解决透明传输的问题  

![字节填充](images/network20.png)

#### 错误检测和纠正

差错出现的特点：随机，连续突发（burst）  
处理差错的两种基本策略  
使用纠错码：发送方在每个数据块中加入足够的冗余信息，使得接收方能够判断接收到的数据是否有错，并能纠正错误。  
使用检错码：发送方在每个数据块中加入足够的冗余信息，使得接收方能够判断接收到的数据是否有错，但不能判断哪里有错。  

##### 纠错码

码字（codeword）：一个帧包括m个数据位，r个校验位，n = m + r，则此n比特单元称为n位码字。  
海明距离（Hamming distance）：两个码字之间不同的比特(对应)位数目。  
例：0000000000 与0000011111的海明距离为5  
如果两个码字的海明距离为d，则需要d个单比特错就可以把一个码字转换成另一个码字；  
对于n位码字的集合，只有2m个码字是有效的。也就是说，通常并未使用所有2n个码字。  

[关于海明码的原理和计算](https://www.jianshu.com/p/54d1adc74314)

纠正码字中的单个数据位错误

![纠正码字中的单个数据位错误](images/network21.png)
![纠正码字中的单个数据位错误](images/network22.png)
![纠正码字中的单个数据位错误](images/network23.png)
![纠正码字中的单个数据位错误](images/network24.png)

在实际通信中使用纠错码好还是检错码好呢？  
例如：假设一个信道误码率是10-6，且出错是孤立产生的（即只有单比特错），数据块长度为1000比特，如果采用纠错编码，需要10个校验位（210>1011），传送1M数据需要10000个校验位；如果采用检错编码，每个数据块只需一个奇偶校验位，传送1M数据只需1000个校验位和一个重传的数据1001位，共需要2001比特的额外开销。  
在多数通信中采用检错编码，但在单工信道中需要纠错编码。  

##### 改进的奇偶校验

将数据位组成一个n位宽，K位高的长方形距阵来发送，然后对每一列单独计算奇偶位，并附在最后一行作为冗余位。  

![改进的奇偶校验](images/network25.png)

##### 检错码

使用纠错码传数据，效率低，适用于不可能重传的场合；大多数情况采用检错码加重传。  
循环冗余码（CRC码，多项式编码）  
110001，表示成多项式 x^5 + x^4 + 1  
生成多项式G(x)  
发方、收方事前商定；  
生成多项式的高位和低位必须为1  
生成多项式必须比传输信息对应的多项式短。  

CRC码基本思想  
校验和（checksum）加在帧尾，使带校验和的帧的多项式能被G(x)除尽；收方接收时，用G(x)去除它，若有余数，则传输出错。  
校验和计算算法  
设G(x)为 r 阶，在帧的末尾加 r 个0，使帧为m+r位，相应多项式为xrM(x)；  
按模2除法用对应于G(x)的位串去除对应于xrM(x)的位串；  
按模2减法从对应于xrM(x)的位串中减去余数(等于或小于r位)，结果就是要传送的带校验和的多项式T(x)。  

多项式编码校验和计算示例  

![多项式编码校验和计算示例](images/network26.png)

CRC的检错能力  
发送：T(x)；接收：T(x) + E(x), E(x) 不等于 0；  
余数((T(x) + E(x)) / G(x)) = 0 + 余数(E(x) / G(x))  
若余数(E(x) / G(x)) = 0，则差错不能发现；否则，可以发现。  

CRC检错能力的几种情况分析  
如果只有单比特错，即E(x) = x^i，而G(x)中至少有两项，余数(E(x) / G(x)) 不等于 0，所以可以查出单比特错；  
如果发生两个孤立单比特错，即E(x) = xi + xj = xj (xi-j + 1)，假定G(x)不能被x整除，那么能够发现两个比特错的充分条件是：xk + 1不能被G(x)整除 (k =< i - j)；  
如果有奇数个比特错，即E(x)包括奇数个项，G(x)选(x + 1)的倍数就能查出奇数个比特错；  

#### 帧检验序列 FCS

在数据后面添加上的冗余码称为帧检验序列 FCS (Frame Check Sequence)。  
循环冗余检验 CRC 和帧检验序列 FCS并不等同。  
CRC 是一种常用的检错方法，而 FCS 是添加在数据后面的冗余码。  
FCS 可以用 CRC 这种方法得出，但 CRC 并非用来获得 FCS 的惟一方法。  

只要得出的余数R 不为0，就表示检测到了差错。  
但这种检测方法并不能确定究竟是哪一个或哪几个比特出现了差错。  
一旦检测出差错，就丢弃这个出现差错的帧。  
只要经过严格的挑选，并使用位数足够多的除数P，那么出现检测不到的差错的概率就很小很小。  

仅用循环冗余检验 CRC 差错检测技术只能做到无差错接受(accept)。  
“无差错接受”是指：“凡是接受的帧（即不包括丢弃的帧），我们都能以非常接近于 1 的概率认为这些帧在传输过程中没有产生差错”。  
也就是说：“凡是接受的帧都没有传输差错”（有差错的帧就丢弃而不接受）。  
要做到“可靠传输”（即发送什么就收到什么）就必须再加上确认和重传机制。  

### 点对点协议 PPP

现在全世界使用得最多的数据链路层协议是点对点协议 PPP (Point-to-Point Protocol)。  
用户使用拨号电话线接入因特网时，一般都是使用 PPP 协议。  

PPP 协议应满足的需求  

- 简单——这是首要的要求
- 封装成帧
- 透明性
- 多种网络层协议
- 多种类型链路
- 差错检测
- 检测连接状态
- 最大传送单元
- 网络层地址协商
- 数据压缩协商  

PPP 协议不需要的功能

- 纠错
- 流量控制
- 序号
- 多点线路
- 半双工或单工链路

PPP 协议有三个组成部分  

1. 一个将 IP 数据报封装到串行链路的方法。
2. 链路控制协议 LCP (Link Control Protocol)。
3. 网络控制协议 NCP (Network Control Protocol)。  

PPP 协议的帧格式  

标志字段 F = 0x7E （符号“0x”表示后面的字符是用十六进制表示。十六进制的 7E 的二进制表示是 01111110）。  
地址字段 A 只置为 0xFF。地址字段实际上并不起作用。  
控制字段 C 通常置为 0x03。  
PPP 是面向字节的，所有的 PPP 帧的长度都是整数字节。  

![PPP 协议的帧格式](images/network27.png)

当 PPP 用在同步传输链路时，协议规定采用硬件来完成比特填充（和 HDLC 的做法一样）。  
当 PPP 用在异步传输时，就使用一种特殊的字符填充法。  

#### 字符填充

将信息字段中出现的每一个 0x7E 字节转变成为 2 字节序列(0x7D, 0x5E)。  
若信息字段中出现一个 0x7D 的字节, 则将其转变成为 2 字节序列(0x7D, 0x5D)。  
若信息字段中出现 ASCII 码的控制字符（即数值小于 0x20 的字符），则在该字符前面要加入一个 0x7D 字节，同时将该字符的编码加以改变。  

#### 零比特填充

PPP 协议用在 SONET/SDH 链路时，是使用同步传输（一连串的比特连续传送）。这时 PPP 协议采用零比特填充方法来实现透明传输。  
在发送端，只要发现有 5 个连续 1，则立即填入一个 0。接收端对帧中的比特流进行扫描。每当发现 5 个连续1时，就把这 5 个连续 1 后的一个 0 删除。  

![零比特填充](images/network28.png)

PPP 协议之所以不使用序号和确认机制是出于以下的考虑：

- 在数据链路层出现差错的概率不大时，使用比较简单的 PPP 协议较为合理。
- 在因特网环境下，PPP 的信息字段放入的数据是 IP 数据报。数据链路层的可靠传输并不能够保证网络层的传输也是可靠的。
- 帧检验序列 FCS 字段可保证无差错接受。  

PPP 协议的工作状态  

当用户拨号接入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。  
PC 机向路由器发送一系列的 LCP 分组（封装成多个 PPP 帧）。  
这些分组及其响应选择一些 PPP 参数，和进行网络层配置，NCP 给新接入的 PC机分配一个临时的 IP 地址，使 PC 机成为因特网上的一个主机。  
通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层的连接。  

![PPP](images/network29.png)

### 使用广播信道的数据链路层

#### 局域网的数据链路层

局域网最主要的特点是：网络为一个单位所拥有，且地理范围和站点数目均有限。  
局域网具有如下的一些主要优点：  
具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源。  
便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变。  
提高了系统的可靠性、可用性和残存性。  

局域网的拓扑

![局域网的拓扑](images/network30.png)

#### 数据链路层的两个子层

为了使数据链路层能更好地适应多种局域网标准，802 委员会就将局域网的数据链路层拆成两个子层：  
逻辑链路控制 LLC (Logical Link Control)子层  
媒体接入控制 MAC (Medium Access Control)子层。  
与接入到传输媒体有关的内容都放在 MAC子层，而 LLC 子层则与传输媒体无关，不管采用何种协议的局域网对 LLC 子层来说都是透明的  

#### 适配器的作用  

网络接口板又称为通信适配器(adapter)或网络接口卡 NIC (Network Interface Card)，或“网卡”。  
适配器的重要功能：  
进行串行/并行转换。  
对数据进行缓存。  
在计算机的操作系统安装设备驱动程序。  
实现以太网协议。  

以太网发送的数据都使用曼彻斯特(Manchester)编码  

![Manchester](images/network31.png)

曼彻斯特编码中，每一位的中间有一跳变，位中间的跳变既作时钟信号，又作数据信号；从高到低跳变表示" 1"，从低到高跳变表示" 0"。  
差分曼彻斯特编码，每位中间的跳变仅提供时钟定时，而用每位开始时有无跳变表示"0"或"1"，有跳变为"0"，无跳变为"1"。  
两种曼彻斯特编码是将时钟和数据包含在数据流中，在传输代码信息的同时，也将时钟同步信号一起传输到对方，每位编码中有一跳变，不存在直流分量，因此具有自同步能力和良好的抗干扰性能。但每一个码元都被调成两个电平，所以数据传输速率只有调制速率的1/2。  

#### 载波监听多点接入/碰撞检测  CSMA/CD

CSMA/CD 表示 Carrier Sense Multiple Access with Collision Detection。  
“多点接入”表示许多计算机以多点接入的方式连接在一根总线上。  
“载波监听”是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞。  
总线上并没有什么“载波”。因此， “载波监听”就是用电子技术检测总线上有没有其他计算机发送的数据信号。  

#### 碰撞检测

“碰撞检测”就是计算机边发送数据边检测信道上的信号电压大小。  
当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。  
当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。  
所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称为“冲突检测”。  

在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。  
每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。  

重要特性  

- 使用 CSMA/CD 协议的以太网不能进行全双工通信而只能进行双向交替通信（半双工通信）。  
- 每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。  
- 这种发送的不确定性使整个以太网的平均通信量远小于以太网的最高数据率。  

最先发送数据帧的站，在发送数据帧后至多经过时间 2 （两倍的端到端往返时延）就可知道发送的数据帧是否遭受了碰撞。  
以太网的端到端往返时延 2 称为争用期，或碰撞窗口。  
经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。  

#### 二进制指数类型退避算法 (truncated binary exponential type)

发生碰撞的站在停止发送数据后，要推迟（退避）一个随机时间才能再发送数据。  
基本退避时间取为争用期 2T。  
从整数集合[0,1,…, (2^k-1)]中随机地取出一个数，记为 r。重传所需的时延就是 r 倍的基本退避时间。  
参数 k 按下面的公式计算：  
                 k = Min[重传次数, 10]  
当 k =< 10 时，参数 k 等于重传次数。  
当重传达 16 次仍不能成功时即丢弃该帧，并向高层报告。  

以太网取 51.2 us 为争用期的长度。  
对于 10 Mb/s 以太网，在争用期内可发送512 bit，即 64 字节。  
以太网在发送数据时，若前 64 字节没有发生冲突，则后续的数据就不会发生冲突。  

如果发生冲突，就一定是在发送的前 64 字节之内。  
由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于 64 字节。  
以太网规定了最短有效帧长为 64 字节，凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧。  

当发送数据的站一旦发现发生了碰撞时：  
立即停止发送数据；  
再继续发送若干比特的人为干扰信号(jamming signal)，以便让所有用户都知道现在已经发生了碰撞。  

以太网的信道被占用的情况：  
争用期长度为 2，即端到端传播时延的两倍。检测到碰撞后不发送干扰信号。  
帧长为 L (bit)，数据发送速率为 C (b/s)，因而帧的发送时间为 L/C = T0 (s)。  

信道利用率的最大值 Smax  

在理想化的情况下，以太网上的各站发送数据都不会产生碰撞（这显然已经不是 CSMA/CD，而是需要使用一种特殊的调度方法），即总线一旦空闲就有某一个站立即发送数据。  
发送一帧占用线路的时间是 T0 + ，而帧本身的发送时间是 T0。于是我们可计算出理想情况下的极限信道利用率 Smax为：  

Smax = T0/(TO+T) = 1/(1+a)

#### 以太网的 MAC 层

在局域网中，硬件地址又称为物理地址，或 MAC 地址。  
802 标准所说的“地址”严格地讲应当是每一个站的“名字”或标识符。  

适配器从网络上每收到一个 MAC 帧就首先用硬件检查 MAC 帧中的 MAC 地址.  
如果是发往本站的帧则收下，然后再进行其他的处理。  
否则就将此帧丢弃，不再进行其他的处理。  
“发往本站的帧”包括以下三种帧：  
单播(unicast)帧（一对一）  
广播(broadcast)帧（一对全体）  
多播(multicast)帧（一对多）  

常用的以太网MAC帧格式有两种标准 ：  
DIX Ethernet V2 标准  
IEEE 的 802.3 标准  
最常用的 MAC 帧是以太网 V2 的格式。  

以太网的 MAC 帧格式  

![以太网的 MAC 帧格式 ](images/network32.png)

无效的 MAC 帧  

- 数据字段的长度与长度字段的值不一致；  
- 帧的长度不是整数个字节；  
- 用收到的帧检验序列 FCS 查出有差错；  
- 数据字段的长度不在 46 ~ 1500 字节之间。  
- 有效的 MAC 帧长度为 64 ~ 1518 字节之间。  
- 对于检查出的无效 MAC 帧就简单地丢弃。以太网不负责重传丢弃的帧。  

帧间最小间隔  

帧间最小间隔为 9.6 us，相当于 96 bit 的发送时间。  
一个站在检测到总线开始空闲后，还要等待 9.6 us 才能再次发送数据。  
这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备。  

### 在数据链路层扩展局域网

在数据链路层扩展局域网是使用网桥。  
网桥工作在数据链路层，它根据 MAC 帧的目的地址对收到的帧进行转发。  
网桥具有过滤帧的功能。当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的 MAC 地址，然后再确定将该帧转发到哪一个接口  

网桥的内部结构

![网桥的内部结构](images/network33.png)

使用网桥带来的好处  

- 过滤通信量。
- 扩大了物理范围。
- 提高了可靠性。
- 可互连不同物理层、不同 MAC 子层和不同速率（如10 Mb/s 和 100 Mb/s 以太网）的局域网。  

网桥使各网段成为隔离开的碰撞域  

![网桥](images/network34.png)

使用网桥带来的缺点

- 存储转发增加了时延。  
- 在MAC 子层并没有流量控制功能。  
- 具有不同 MAC 子层的网段桥接在一起时时延更大。  
- 网桥只适合于用户数不太多(不超过几百个)和通信量不太大的局域网，否则有时还会因传播过多的广播信息而产生网络拥塞。这就是所谓的广播风暴。  

网桥和集线器（或转发器）不同  

集线器在转发帧时，不对传输媒体进行检测。  
网桥在转发帧之前必须执行 CSMA/CD 算法。若在发送过程中出现碰撞，就必须停止发送和进行退避。  

目前使用得最多的网桥是透明网桥(transparent bridge)。  
“透明”是指局域网上的站点并不知道所发送的帧将经过哪几个网桥，因为网桥对各站来说是看不见的。  
透明网桥是一种即插即用设备，其标准是 IEEE 802.1D。  

网桥应当按照以下自学习算法处理收到的帧和建立转发表  

- 若从 A 发出的帧从接口 x 进入了某网桥，那么从这个接口出发沿相反方向一定可把一个帧传送到 A。  
- 网桥每收到一个帧，就记下其源地址和进入网桥的接口，作为转发表中的一个项目。  
- 在建立转发表时是把帧首部中的源地址写在“地址”这一栏的下面。  
- 在转发帧时，则是根据收到的帧首部中的目的地址来转发的。这时就把在“地址”栏下面已经记下的源地址当作目的地址，而把记下的进入接口当作转发接口。  

网桥在转发表中登记以下三个信息  

在网桥的转发表中写入的信息除了地址和接口外，还有帧进入该网桥的时间。  
这是因为以太网的拓扑可能经常会发生变化，站点也可能会更换适配器（这就改变了站点的地址）。另外，以太网上的工作站并非总是接通电源的。  
把每个帧到达网桥的时间登记下来，就可以在转发表中只保留网络拓扑的最新状态信息。这样就使得网桥中的转发表能反映当前网络的最新拓扑状态。  

网桥的自学习和转发帧的步骤归纳  

网桥收到一帧后先进行自学习。查找转发表中与收到帧的源地址有无相匹配的项目。如没有，就在转发表中增加一个项目（源地址、进入的接口和时间）。如有，则把原有的项目进行更新。  
转发帧。查找转发表中与收到帧的目的地址有无相匹配的项目。  

- 如没有，则通过所有其他接口（但进入网桥的接口除外）按进行转发。
- 如有，则按转发表中给出的接口进行转发。
- 若转发表中给出的接口就是该帧进入网桥的接口，则应丢弃这个帧（因为这时不需要经过网桥进行转发）。  

## 网络层

### 虚拟互连网络

所谓虚拟互连网络也就是逻辑互连网络，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络。  
使用 IP 协议的虚拟互连网络可简称为 IP 网。  
使用虚拟互连网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。  

### 分类的 IP 地址

IP 地址就是给每个连接在因特网上的主机（或路由器）分配一个在全世界范围是唯一的 32 位的标识符。  
IP 地址现在由因特网名字与号码指派公司ICANN (Internet Corporation for Assigned Names and Numbers)进行分配  

每一类地址都由两个固定长度的字段组成，其中一个字段是网络号 net-id，它标志主机（或路由器）所连接到的网络，而另一个字段则是主机号 host-id，它标志该主机（或路由器）。  
两级的 IP 地址可以记为：  

IP 地址 ::= { <网络号>, <主机号>}  

::= 代表“定义为”  

IP 地址中的网络号字段和主机号字段  

![IP](images/network35.png)

点分十进制记法  

![IP](images/network36.png)

常用的三种类别的 IP 地址

![IP](images/network37.png)

(1) IP 地址是一种分等级的地址结构。分两个等级的好处是：  
第一，IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理。  
第二，路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间。  

(2) 实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口。  
当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为多归属主机(multihomed host)。  
由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此一个路由器至少应当有两个不同的 IP 地址。  

(3) 用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号 net-id。  
(4) 所有分配到网络号 net-id 的网络，无论是范围很小的局域网，还是覆盖很大地理范围的广域网，都是平等的。  

#### 特殊地址

特殊IP地址  
0.0.0.0：			本主机  
00…00主机：		本网中的主机  
255.255.255.255：		局域网中的广播  
网络11…11：		对一个远程网的广播  
127.x.y.z：			回路测试或C/S环境S的地址  
A、B、C类三段私有地址：  
10.0.0.0~10.255.255.255/8；172.16.0.0~172.31.255.255/12； 192.168.0.0 ~255.255/16  

### 地址解析协议 ARP

不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。  
每一个主机都设有一个 ARP 高速缓存(ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。  
当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。  
如果ARP缓存中没有目的主机的MAC地址怎么办？  

















参考：https://time.geekbang.org/column/article/7724  
